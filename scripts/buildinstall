#!/bin/bash

if [ ! -d $1/RedHat/RPMS ]; then
    echo $1 is not a Red Hat image >&2
    exit 1
fi

p=$1

BUILDINSTDIR=/tmp/buildinstall.tree.$$

rm -rf $BUILDINSTDIR
mkdir -p $BUILDINSTDIR

UPD_INSTROOT=./upd-instroot
MK_IMAGES=./mk-images

BUILDARCH=`rpm -qp --qf "%{ARCH}" $p/RedHat/RPMS/anaconda-runtime-[0-9]*`

if [ ! -f $UPD_INSTROOT ]; then
    cd $BUILDINSTDIR
    rpm2cpio $p/RedHat/RPMS/anaconda-runtime-[0-9]* | cpio --quiet -iumd usr/lib/anaconda-runtime/upd-instroot
    mv usr/lib/anaconda-runtime/upd-instroot .
    rm -rf usr
    UPD_INSTROOT=$BUILDINSTDIR/upd-instroot
fi

if [ ! -f $MK_IMAGES ]; then
    cd $BUILDINSTDIR
    rpm2cpio $p/RedHat/RPMS/anaconda-runtime-[0-9]* | cpio --quiet -iumd usr/lib/anaconda-runtime/mk-images*
    mv usr/lib/anaconda-runtime/mk-images* .
    rm -rf usr
    MK_IMAGES=$BUILDINSTDIR/mk-images
fi

$UPD_INSTROOT $p/RedHat/RPMS $p/image-template $p/RedHat/instimage $BUILDARCH
$MK_IMAGES $p/RedHat/RPMS $p $p/image-template $BUILDARCH

rm -rf $BUILDINSTDIR
#rm -rf $p/image-template $p/RedHat/instimage/usr/lib/anaconda-runtime
